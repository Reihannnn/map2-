<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Offline - Story Map App</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem;
        color: white;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .offline-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 1.5rem;
      }

      .actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 2rem;
      }

      .btn {
        background: white;
        color: #667eea;
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .stats {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 2rem;
      }

      .stats h3 {
        margin-bottom: 0.5rem;
      }

      .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
      }

      .stories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .story-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .story-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .story-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .story-photo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid rgba(255, 255, 255, 0.5);
        flex-shrink: 0;
      }

      .story-photo-placeholder {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        border: 3px solid rgba(255, 255, 255, 0.5);
        flex-shrink: 0;
      }

      .story-info {
        flex: 1;
      }

      .story-name {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
        word-break: break-word;
      }

      .story-id {
        font-size: 0.85rem;
        opacity: 0.7;
        font-family: monospace;
      }

      .story-description {
        margin-top: 1rem;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        line-height: 1.5;
        word-break: break-word;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-bottom: 2rem;
      }

      .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .loading {
        text-align: center;
        padding: 2rem;
      }

      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @media (max-width: 768px) {
        .stories-grid {
          grid-template-columns: 1fr;
        }
        
        h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="offline-icon">üì°</div>
        <h1>Mode Offline</h1>
        <p class="subtitle">
          Tidak ada koneksi internet. Data di bawah ini dari cache lokal.
        </p>
      </div>

      <div class="actions">
        <button class="btn" onclick="window.location.reload()">
          <span>üîÑ</span>
          <span>Coba Lagi</span>
        </button>
        <button class="btn btn-danger" id="clearCacheBtn">
          <span>üóëÔ∏è</span>
          <span>Hapus Semua Cache</span>
        </button>
      </div>

      <div class="stats">
        <h3>Total Stories Tersimpan</h3>
        <div class="stats-number" id="totalStories">-</div>
      </div>

      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p>Memuat data dari cache...</p>
      </div>

      <div id="storiesContainer" style="display: none;"></div>
    </div>

    <script type="module">
      // Auto-reload when back online
      window.addEventListener("online", () => {
        window.location.reload();
      });

      // Check connection status every 5 seconds
      function checkConnection() {
        if (navigator.onLine) {
          window.location.reload();
        }
      }
      setInterval(checkConnection, 5000);

      // üóÇÔ∏è Ambil dan tampilkan data stories
      document.addEventListener("DOMContentLoaded", async () => {
        const loadingState = document.getElementById("loadingState");
        const storiesContainer = document.getElementById("storiesContainer");
        const totalStoriesEl = document.getElementById("totalStories");

        try {
          // Import fungsi dari db.js
          const { getStories, clearStories } = await import("./src/utils/db.js");
          
          // Ambil stories dari IndexedDB
          const stories = await getStories();
          
          // üì¶ Console.log untuk debugging
          console.log("üì¶ Cached Stories:", stories);
          console.log(`Total cached stories: ${stories.length}`);

          // Update total stories
          totalStoriesEl.textContent = stories.length;

          // Sembunyikan loading
          loadingState.style.display = "none";
          storiesContainer.style.display = "block";

          // Tampilkan stories atau empty state
          if (stories.length > 0) {
            displayStories(stories);
          } else {
            displayEmptyState();
          }

          // Event listener untuk tombol hapus cache
          document.getElementById("clearCacheBtn").addEventListener("click", async () => {
            if (confirm("Yakin ingin menghapus semua cache stories? Data tidak bisa dikembalikan!")) {
              try {
                await clearStories();
                console.log("‚úÖ Cache berhasil dihapus!");
                alert("Cache berhasil dihapus! Halaman akan di-reload.");
                window.location.reload();
              } catch (error) {
                console.error("‚ùå Gagal hapus cache:", error);
                alert("Gagal menghapus cache. Coba lagi.");
              }
            }
          });

        } catch (err) {
          console.error("‚ùå Gagal ambil stories offline:", err);
          loadingState.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">‚ö†Ô∏è</div>
              <h3>Gagal Memuat Data</h3>
              <p>Terjadi kesalahan saat mengambil data dari cache.</p>
            </div>
          `;
        }
      });

      // Fungsi untuk menampilkan stories dalam card
      function displayStories(stories) {
        const container = document.getElementById("storiesContainer");
        
        const storiesHTML = `
          <div class="stories-grid">
            ${stories.map(story => createStoryCard(story)).join("")}
          </div>
        `;
        
        container.innerHTML = storiesHTML;
      }

      // Fungsi untuk membuat card story
      function createStoryCard(story) {
        const photoHTML = story.photoUrl 
          ? `<img src="${story.photoUrl}" alt="${story.name}" class="story-photo" onerror="this.style.display='none'">`
          : `<div class="story-photo-placeholder">${getInitial(story.name)}</div>`;

        return `
          <div class="story-card">
            <div class="story-header">
              ${photoHTML}
              <div class="story-info">
                <div class="story-name">${escapeHtml(story.name)}</div>
                <div class="story-id">#${story.id}</div>
              </div>
            </div>
            <div class="story-description">
              ${escapeHtml(story.description)}
            </div>
          </div>
        `;
      }

      // Fungsi untuk menampilkan empty state
      function displayEmptyState() {
        const container = document.getElementById("storiesContainer");
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <h3>Belum Ada Cache</h3>
            <p>Belum ada stories yang tersimpan di cache. Hubungkan ke internet untuk memuat data.</p>
          </div>
        `;
      }

      // Helper: Ambil inisial nama
      function getInitial(name) {
        return name ? name.charAt(0).toUpperCase() : "?";
      }

      // Helper: Escape HTML untuk keamanan
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>